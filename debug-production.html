<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug MAIS Production</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .test-button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Debug MAIS Production Issues</h1>
        
        <div id="status"></div>
        
        <h2>🧪 Tests Automáticos</h2>
        <button class="test-button" onclick="testEnvironmentVariables()">Test Environment Variables</button>
        <button class="test-button" onclick="testSupabaseConnection()">Test Supabase Connection</button>
        <button class="test-button" onclick="testLogos()">Test Logo Loading</button>
        <button class="test-button" onclick="testServiceWorker()">Test Service Worker</button>
        <button class="test-button" onclick="runAllTests()">Run All Tests</button>
        
        <div id="logs" class="log"></div>
        
        <h2>📊 Environment Status</h2>
        <div id="env-status"></div>
        
        <h2>🖼️ Asset Loading Test</h2>
        <div id="assets-test">
            <img id="test-app-ico" src="/app.ico" alt="app.ico test" style="width:64px;height:64px;border:1px solid #ccc;margin:5px;" onerror="logAssetError('app.ico')" onload="logAssetSuccess('app.ico')">
            <img id="test-app-png" src="/app.png" alt="app.png test" style="width:64px;height:64px;border:1px solid #ccc;margin:5px;" onerror="logAssetError('app.png')" onload="logAssetSuccess('app.png')">
            <img id="test-mais-logo" src="/mais-logo.svg" alt="mais-logo.svg test" style="width:64px;height:64px;border:1px solid #ccc;margin:5px;" onerror="logAssetError('mais-logo.svg')" onload="logAssetSuccess('mais-logo.svg')">
        </div>
        
        <h2>📝 Console Logs</h2>
        <div id="console-logs" class="log"></div>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            
            const logsDiv = document.getElementById('logs');
            logsDiv.textContent = logs.join('\n');
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logEntry);
        }
        
        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        function logAssetError(asset) {
            log(`❌ Asset failed to load: ${asset}`, 'error');
        }
        
        function logAssetSuccess(asset) {
            log(`✅ Asset loaded successfully: ${asset}`, 'success');
        }
        
        function testEnvironmentVariables() {
            log('Testing environment variables...', 'info');
            
            // Check if we can detect env vars in the built code
            const hasSupabaseUrl = window.location.href.includes('supabase') || document.head.innerHTML.includes('supabase');
            const hasGeminiKey = document.head.innerHTML.includes('generativelanguage');
            
            if (hasSupabaseUrl) {
                log('✅ Supabase URL detected in build', 'success');
            } else {
                log('❌ Supabase URL not detected in build', 'error');
            }
            
            if (hasGeminiKey) {
                log('✅ Gemini API configuration detected', 'success');
            } else {
                log('⚠️ Gemini API configuration not detected', 'warning');
            }
            
            // Check current environment
            log(`Current URL: ${window.location.href}`, 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
            log(`Is HTTPS: ${window.location.protocol === 'https:'}`, 'info');
        }
        
        async function testSupabaseConnection() {
            log('Testing Supabase connection...', 'info');
            
            try {
                // Try to detect if Supabase client is loaded
                if (typeof window !== 'undefined') {
                    // Check if any script contains supabase references
                    const scripts = Array.from(document.querySelectorAll('script[src]'));
                    const supabaseScript = scripts.find(s => s.src.includes('supabase-auth'));
                    
                    if (supabaseScript) {
                        log('✅ Supabase auth script found', 'success');
                    } else {
                        log('❌ Supabase auth script not found', 'error');
                    }
                }
                
                // Test basic connectivity
                const testUrl = 'https://djgkjtqpzedxnqwqdcjx.supabase.co/rest/v1/';
                fetch(testUrl, { method: 'HEAD' })
                    .then(response => {
                        if (response.ok || response.status === 401) {
                            log('✅ Supabase endpoint is reachable', 'success');
                        } else {
                            log(`❌ Supabase endpoint returned: ${response.status}`, 'error');
                        }
                    })
                    .catch(error => {
                        log(`❌ Supabase connection failed: ${error.message}`, 'error');
                    });
                    
            } catch (error) {
                log(`❌ Supabase test failed: ${error.message}`, 'error');
            }
        }
        
        function testLogos() {
            log('Testing logo assets...', 'info');
            
            const logos = ['/app.ico', '/app.png', '/mais-logo.svg'];
            
            logos.forEach(logo => {
                const img = new Image();
                img.onload = () => log(`✅ Logo loaded: ${logo}`, 'success');
                img.onerror = () => log(`❌ Logo failed: ${logo}`, 'error');
                img.src = logo;
            });
        }
        
        function testServiceWorker() {
            log('Testing Service Worker...', 'info');
            
            if ('serviceWorker' in navigator) {
                log('✅ Service Worker API available', 'success');
                
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        log(`✅ ${registrations.length} service worker(s) registered`, 'success');
                        registrations.forEach((reg, i) => {
                            log(`SW ${i+1}: ${reg.scope}`, 'info');
                        });
                    } else {
                        log('⚠️ No service workers registered', 'warning');
                    }
                });
                
                // Try to register SW
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        log('✅ Service Worker registration successful', 'success');
                    })
                    .catch(error => {
                        log(`❌ Service Worker registration failed: ${error.message}`, 'error');
                    });
            } else {
                log('❌ Service Worker not supported', 'error');
            }
        }
        
        function runAllTests() {
            log('🚀 Running all tests...', 'info');
            testEnvironmentVariables();
            setTimeout(() => testSupabaseConnection(), 500);
            setTimeout(() => testLogos(), 1000);
            setTimeout(() => testServiceWorker(), 1500);
        }
        
        // Capture console logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = function(...args) {
            const message = args.join(' ');
            document.getElementById('console-logs').textContent += `LOG: ${message}\n`;
            originalConsoleLog.apply(console, args);
        };
        
        console.error = function(...args) {
            const message = args.join(' ');
            document.getElementById('console-logs').textContent += `ERROR: ${message}\n`;
            originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
            const message = args.join(' ');
            document.getElementById('console-logs').textContent += `WARN: ${message}\n`;
            originalConsoleWarn.apply(console, args);
        };
        
        // Auto-run tests on load
        window.addEventListener('load', () => {
            setStatus('🔍 Debug tool loaded - ready for testing', 'info');
            log('Debug tool initialized', 'success');
            
            // Auto-test assets
            setTimeout(() => {
                runAllTests();
            }, 1000);
        });
        
        // Monitor page errors
        window.addEventListener('error', (e) => {
            log(`❌ Page Error: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            log(`❌ Unhandled Promise Rejection: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>